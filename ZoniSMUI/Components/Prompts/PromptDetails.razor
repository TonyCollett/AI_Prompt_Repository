@page "/Prompt/Details/{PromptId}"
@attribute [Authorize]
@inject AuthenticationStateProvider authProvider
@inject NavigationManager navManager
@inject IDialogService DialogService
@inject IPromptData promptData
@inject IUserData userData

@if (prompt != null)
{
    <MudPaper Class="pa-3" Elevation="4">
    <MudGrid>
        <MudItem xs="12">
            <MudStack Spacing="8" AlignItems="AlignItems.Center" Row="true">
                <MudAvatar Color="Color.Warning" Variant="Variant.Filled">
                    <MudIcon Color="Color.Dark" Icon="@Icons.Custom.Uncategorized.Radioactive" Size="Size.Large" />
                </MudAvatar>
                <MudStack Spacing="1" Justify="Justify.Center">
                    <MudText Typo="Typo.body1">
                        @prompt.Id
                    </MudText>
                </MudStack>
                <MudText Typo="Typo.h5">@prompt.Title</MudText>
            </MudStack>
        </MudItem>
        <MudItem xs="10">
            <MudStack>
                <MudItem xs="12">
                    <MudStack Row="true">
                        <MudItem xs="2">
                            <MudPaper Elevation="2" Class="pa-3">
                                <MudStack>
                                    <MudText Typo="Typo.overline">Created Details</MudText>
                                    <MudText Typo="Typo.caption">@prompt.CreatedBy.DisplayName</MudText>
                                    <MudText Typo="Typo.caption">@prompt.DateCreated</MudText>
                                </MudStack>
                            </MudPaper>
                        </MudItem>
                    </MudStack>
                </MudItem>
                <MudItem xs="12">
                    <MudTabs Outlined="true" Position="Position.Left" Rounded="true" Border="true"
                        ApplyEffectsToContainer="true" Class="ma-3" PanelClass="pa-4">
                        <MudTabPanel Text="General">
                            <MudGrid>
                                <MudItem lg="12" sm="12">
                                    <MudTextField Variant="Variant.Outlined" T="string" Label="Title"
                                        @bind-Value="prompt.Title" ReadOnly="true" />
                                </MudItem>
                                <MudItem lg="12" sm="12">
                                    <MudTextField Variant="Variant.Outlined" T="string" Label="Description"
                                        @bind-Value="prompt.Description" Lines="12" ReadOnly="true" />
                                </MudItem>
                            </MudGrid>
                        </MudTabPanel>
                        <MudTabPanel Text="Comments">
                            <CommentDisplay ParentId="@prompt.Id" />
                        </MudTabPanel>
                        <MudTabPanel Text="History">
                            <MudText>History</MudText>
                        </MudTabPanel>
                        </MudTabs>
                    </MudItem>
                </MudStack>
            </MudItem>

            <MudItem xs="3">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" @onclick="EditPrompt" Class="ml-auto"
                Disabled="false">
                    Edit
                </MudButton>
            </MudItem>

        </MudGrid>


    </MudPaper>
}
else
{
<MudOverlay DarkBackground="true" ZIndex="9999" AutoClose="true">
    <MudProgressCircular Color="Color.Secondary" Indeterminate="true" />
</MudOverlay>
}



@code {
    [Parameter] public string PromptId { get; set; } = default!;
    [CascadingParameter(Name = "LoggedInUser")] public User LoggedInUser { get; set; }

    private Prompt prompt;

    protected async override Task OnInitializedAsync()
    {
        prompt = await promptData.GetPromptAsync(PromptId);
    }

    private async void EditPrompt()
    {
        BlepItLibrary.Models.Prompt editPrompt = new()
        {
            Title = prompt.Title,
            Description = prompt.Description,
        };

        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            CloseButton = true
        };

        var parameters = new DialogParameters
        {
            ["Prompt"] = editPrompt
        };

        var dialog = DialogService.Show<PromptEdit>($"Edit Prompt {prompt.Id}", parameters, options);

        var result = await dialog.Result;

        if (!result.Canceled)
        {
            prompt.Title = editPrompt.Title;
            prompt.Description = editPrompt.Description;
            StateHasChanged();
        }
    }

}
