@inject ITicketData ticketData
@inject INotificationData notificationData
@inject IUserData userData
@inject IStatusData statusData
@inject ICategoryData categoryData

<MudDialog>
    <DialogContent>
        @if (Ticket != null && users != null)
        {
            <MudGrid>
                <MudItem lg="12" sm="12">
                    <MudTextField Variant="Variant.Outlined" T="string" Label="Title"
                              @bind-Value="Ticket.Title" />
                </MudItem>
                <MudItem lg="12" sm="12">
                    <MudTextField Variant="Variant.Outlined" T="string" Label="Description"
                              @bind-Value="Ticket.Description" Lines="5" />
                </MudItem>
                <MudItem lg="4" sm="12">
                    <MudSelect Variant="Variant.Text" T="User" @bind-Value="@Ticket.AffectedUser" Label="Affected User"
                           AnchorOrigin="Origin.BottomCenter" HelperText="@Ticket.AffectedUser.EmailAddress">
                        @foreach (User user in users)
                        {
                            <MudSelectItem Value="@user">@user.DisplayName</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem lg="4" sm="12">
                    <MudSelect Variant="Variant.Outlined" T="string" Label="Priority"
                           AnchorOrigin="Origin.BottomCenter">
                        <MudSelectItem Value="@("1")" />
                        <MudSelectItem Value="@("2")" />
                        <MudSelectItem Value="@("3")" />
                        <MudSelectItem Value="@("4")" />
                        <MudSelectItem Value="@("5")" />
                    </MudSelect>
                </MudItem>
                <MudItem lg="4" sm="12">
                    <MudSelect Variant="Variant.Outlined" T="User" @bind-Value="@Ticket.AssignedUser" Label="Assigned User"
                           AnchorOrigin="Origin.BottomCenter">
                        @foreach (User user in users)
                        {
                            <MudSelectItem Value="@user">@user.DisplayName</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
            </MudGrid>
        }
        else
        {
            <MudOverlay DarkBackground="true" ZIndex="9999" AutoClose="true">
                <MudProgressCircular Color="Color.Secondary" Indeterminate="true" />
            </MudOverlay>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@Close">Cancel</MudButton>
        <MudButton OnClick="@SaveDialogAsync" Color="Color.Primary">Save</MudButton>
    </DialogActions>
</MudDialog>



@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; }
    [CascadingParameter] List<ZoniSMLibrary.Models.Setting> ApplicationSettings { get; set; }
    [Parameter] public ZoniSMLibrary.Models.Ticket Ticket { get; set; }

    private IEnumerable<User> users;

    protected async override Task OnInitializedAsync()
    {
        users = await userData.GetAllUsersAsync();
    }

    private async void SaveDialogAsync()
    {
        Notification newAssignmentNotification = new Notification()
            {
                Title = $"ticketID has been assigned to you",
                Contents = $"You have been assigned a new Ticket",
                Type = "Normal Notification",
                ForUser = Ticket.AssignedUser
            };

        Notification newAffectedUserNotification = new Notification()
            {
                Title = $"ticketID has been created for you",
                Contents = $"You have a new Ticket",
                Type = "Normal Notification",
                ForUser = Ticket.AffectedUser
            };

        await ticketData.UpdateTicket(Ticket);
        await notificationData.CreateNotificationAsync(newAssignmentNotification);
        await notificationData.CreateNotificationAsync(newAffectedUserNotification);
        MudDialog.Close();
    }

    private void Close()
    {
        MudDialog.Cancel();
    }
}
