@inherits LayoutComponentBase
@inject NavigationManager navManager
@inject AuthenticationStateProvider authProvider
@inject IUserData userData
@inject ISettingsData settingsData
@attribute [Authorize]

<MudThemeProvider @bind-IsDarkMode="@_isDarkMode" Theme="_theme" />
<MudDialogProvider 
    FullWidth="true"
    MaxWidth="MaxWidth.Large"/>
<MudSnackbarProvider />

<PageTitle>@_applicationName</PageTitle>
<AuthorizeView>
    <Authorized>
        <MudLayout>
            <MudAppBar Elevation="1" Dense="false">
                <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@ToggleDrawer" />
                <MudText Class="pl-4" Typo="Typo.h4" @onclick="GoHome">@_applicationName</MudText>
                <MudSpacer />
                <MudStack AlignItems="AlignItems.Center" Row="true">
                    <MudDivider Vertical="true" FlexItem="true" />
                    <MudToggleIconButton @bind-Toggled="@_isDarkMode" 
                        Color="Color.Surface" Icon="@Icons.Material.Filled.DarkMode"
                                         ToggledColor="Color.Primary" ToggledIcon="@Icons.Material.Filled.LightMode" />
                    <MudDivider Vertical="true" FlexItem="true" />
                    @if(_loggedInUser != null) {
                    <LoginDisplay LoggedInUser="@_loggedInUser" />
                    }
                </MudStack>
            </MudAppBar>
            <MudDrawer @bind-Open="@open" ClipMode="clipMode" Elevation="1" Variant="@DrawerVariant.Mini">
                <MudNavMenu Bordered="true">
                    <MudNavGroup Title="Task Management" Icon="@Icons.Material.Filled.Workspaces" Expanded="true">
                        <MudNavLink @onclick="@(() => NavigateTo("Tickets"))" Icon="@Icons.Material.Filled.ReportProblem">
                            Tickets
                        </MudNavLink>
                        <MudNavLink @onclick="@(() => NavigateTo("Tickets/Active"))" Icon="@Icons.Material.Filled.GroupWork">
                            Active Tickets
                        </MudNavLink>
                    </MudNavGroup>
                    <MudNavLink @onclick="@(() => NavigateTo("Settings"))" Icon="@Icons.Material.Filled.VerifiedUser">
                        Users
                    </MudNavLink>
                    <MudNavLink @onclick="@(() => NavigateTo("Settings"))" Icon="@Icons.Material.Filled.List">
                        Categories
                    </MudNavLink>
                    <MudNavLink @onclick="@(() => NavigateTo("Settings"))" Icon="@Icons.Material.Filled.AdminPanelSettings">
                        Settings
                    </MudNavLink>
                </MudNavMenu>
            </MudDrawer>

            <MudMainContent Class="pt-16 px-5 pb-15">
                <MudContainer Class="mt-4" MaxWidth="MaxWidth.ExtraExtraLarge">
                    <CascadingValue Value="@_applicationSettings" Name="ApplicationSettings">
                        <CascadingValue Value="@_loggedInUser" Name="LoggedInUser">
                            @Body
                        </CascadingValue>
                    </CascadingValue>
                </MudContainer>
            </MudMainContent>

            <MudAppBar Bottom="true" Fixed="true" Dense="true">
                <MudSpacer />
                <MudMenu ActivationEvent="@MouseEvent.LeftClick" AnchorOrigin="Origin.TopRight" TransformOrigin="Origin.BottomRight">
                <ActivatorContent>
                    <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Add" Color="Color.Primary">
                        Quick Create
                    </MudButton>
                </ActivatorContent>
                <ChildContent>
                    <MudMenuItem Href="/Ticket/Create/">
                        Ticket
                    </MudMenuItem>
                </ChildContent>
                </MudMenu>
            </MudAppBar>
        </MudLayout>
    </Authorized>
    <NotAuthorized>
        <NotAuthorised />
    </NotAuthorized>
</AuthorizeView>

@code {
    bool open = true;
    DrawerClipMode clipMode = DrawerClipMode.Always;
    private User _loggedInUser;
    private List<Setting> _applicationSettings;
    private string _applicationName;

    protected async override Task OnInitializedAsync()
    {
        var checkusers = await userData.GetAllUsersAsync();

        if (checkusers.Any() == false)
        {
            var tonyAdmin = new User()
            {
                ObjectIdentifier = "22dd62f7-13fc-4c1c-955c-3b93d0cebc73",
                FirstName = "Tony",
                LastName = "Collett",
                EmailAddress = "tony.collett@outlook.com",
                UserType = UserType.Admin,
                Notifications = new List<Notification>()
            };

            await userData.CreateUserAsync(tonyAdmin);
        }

        _loggedInUser = await authProvider.GetUserFromAuth(userData);
        _applicationSettings = await settingsData.GetAllSettingsAsync();
        _applicationName = "ZoniSM"; //_applicationSettings.Where(x => x.Name == "ApplicationName").Select(x => x.Value).First();
    }

    private MudTheme _theme = new();
    private bool _isDarkMode = true;

    void ToggleDrawer()
    {
        open = !open;
    }

    void GoHome()
    {
        navManager.NavigateTo("/");
    }

    void NavigateTo(string url)
    {
        navManager.NavigateTo($"/{url}");
    }
}